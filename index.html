---
layout: none
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=600, initial-scale=1.0">
    <title>Life Stats Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <main class="page">
        <header class="page__header">
            <h1 class="title">Life Stats</h1>
            <p class="subtitle">Personal Tracking Dashboard</p>
        </header>

        <section id="stats" class="stats" aria-live="polite">
            <div class="stat stat--placeholder">Loading stats…</div>
        </section>
    </main>

    <script>
    // Calculate days between two dates
    function daysBetween(date1, date2) {
        const oneDay = 24 * 60 * 60 * 1000;
        return Math.round(Math.abs((date2 - date1) / oneDay));
    }

    // Formula evaluator with date support
    function evaluateFormula(formula, variables, config) {
        try {
            let expression = formula;
            
            // Handle days_since() function
            expression = expression.replace(/days_since\('([^']+)'\)/g, (match, configKey) => {
                if (config && config[configKey]) {
                    const startDate = new Date(config[configKey]);
                    const today = new Date();
                    return daysBetween(startDate, today);
                }
                return 0;
            });

            // Handle today() function - returns current timestamp
            expression = expression.replace(/today\(\)/g, Date.now());

            // Replace variable names with their values
            for (const [key, val] of Object.entries(variables)) {
                const regex = new RegExp('\\b' + key + '\\b', 'g');
                expression = expression.replace(regex, val);
            }
            
            // Only allow safe math operations
            const safeExpression = expression.replace(/[^0-9+\-*/(). ]/g, '');
            return Function('"use strict"; return (' + safeExpression + ')')();
        } catch (e) {
            console.error('Formula evaluation error:', e, formula);
            return 'Error';
        }
    }

    function formatValue(value, format) {
        if (value === 'Error') return value;
        if (format === 'percentage') return value.toFixed(1) + '%';
        if (format === 'decimal') return value.toFixed(2);
        if (format === 'integer') return Math.round(value);
        return value;
    }

    async function loadStats() {
        const container = document.getElementById('stats');

        try {
            const response = await fetch('stats.json', { cache: 'no-store' });
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();

            if (!data.stats || data.stats.length === 0) {
                container.textContent = 'No stats available right now.';
                return;
            }

            // Build variables map from all stats
            const variables = {};
            data.stats.forEach(stat => {
                if (stat.value !== undefined) {
                    variables[stat.id || stat.name] = stat.value;
                }
            });

            container.innerHTML = '';

            data.stats.forEach(stat => {
                const row = document.createElement('div');
                row.className = 'stat';

                const label = document.createElement('div');
                label.className = 'stat__label';
                label.textContent = stat.name || '—';

                const valueDiv = document.createElement('div');
                valueDiv.className = 'stat__value';
                
                let displayValue;
                if (stat.formula) {
                    // Evaluate formula with config support
                    const result = evaluateFormula(stat.formula, variables, data.config);
                    displayValue = formatValue(result, stat.format);
                } else {
                    // Use direct value
                    displayValue = stat.value ?? '0';
                    if (stat.format) {
                        displayValue = formatValue(displayValue, stat.format);
                    }
                }
                
                valueDiv.textContent = displayValue;

                // Add description if present
                if (stat.description) {
                    const desc = document.createElement('div');
                    desc.className = 'stat__description';
                    desc.textContent = stat.description;
                    label.appendChild(desc);
                }

                row.appendChild(label);
                row.appendChild(valueDiv);
                container.appendChild(row);
            });

            // Add last updated timestamp - show current time since calculations are dynamic
            const updated = document.createElement('div');
            updated.className = 'last-updated';
            updated.textContent = 'Calculated: ' + new Date().toLocaleString();
            container.appendChild(updated);
        } catch (error) {
            container.textContent = 'Unable to load stats.';
            console.error('Error loading stats:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>